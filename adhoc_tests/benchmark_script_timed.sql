-- Load data
CREATE TABLE nodes AS SELECT * FROM read_csv_auto('data/processed/nodes_5m.csv');
CREATE TABLE edges AS SELECT * FROM read_csv_auto('data/processed/edges_5m.csv');

-- Initialize GPU
call gpu_buffer_init('4 GB', '8 GB');

.timer on

-- Warm-up query
.print 'Warmup query:'
call gpu_processing('SELECT e1.txId2 AS node_id, MAX(n2.class) AS node_class, 1 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId WHERE n1.class = ''1'' GROUP BY e1.txId2 UNION ALL SELECT e2.txId2 AS node_id, MAX(n3.class) AS node_class, 2 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId WHERE n1.class = ''1'' AND e2.txId2 != n1.txId GROUP BY e2.txId2 UNION ALL SELECT e3.txId2 AS node_id, MAX(n4.class) AS node_class, 3 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId JOIN edges e3 ON n3.txId = e3.txId1 JOIN nodes n4 ON e3.txId2 = n4.txId WHERE n1.class = ''1'' AND e3.txId2 != n1.txId AND e3.txId2 != n2.txId GROUP BY e3.txId2 UNION ALL SELECT e4.txId2 AS node_id, MAX(n5.class) AS node_class, 4 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId JOIN edges e3 ON n3.txId = e3.txId1 JOIN nodes n4 ON e3.txId2 = n4.txId JOIN edges e4 ON n4.txId = e4.txId1 JOIN nodes n5 ON e4.txId2 = n5.txId WHERE n1.class = ''1'' AND e4.txId2 != n1.txId AND e4.txId2 != n2.txId AND e4.txId2 != n3.txId GROUP BY e4.txId2 ORDER BY hop_distance, node_id');

-- Session query 1
.print 'Query 1:'
call gpu_processing('SELECT e1.txId2 AS node_id, MAX(n2.class) AS node_class, 1 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId WHERE n1.class = ''1'' GROUP BY e1.txId2 UNION ALL SELECT e2.txId2 AS node_id, MAX(n3.class) AS node_class, 2 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId WHERE n1.class = ''1'' AND e2.txId2 != n1.txId GROUP BY e2.txId2 UNION ALL SELECT e3.txId2 AS node_id, MAX(n4.class) AS node_class, 3 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId JOIN edges e3 ON n3.txId = e3.txId1 JOIN nodes n4 ON e3.txId2 = n4.txId WHERE n1.class = ''1'' AND e3.txId2 != n1.txId AND e3.txId2 != n2.txId GROUP BY e3.txId2 UNION ALL SELECT e4.txId2 AS node_id, MAX(n5.class) AS node_class, 4 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId JOIN edges e3 ON n3.txId = e3.txId1 JOIN nodes n4 ON e3.txId2 = n4.txId JOIN edges e4 ON n4.txId = e4.txId1 JOIN nodes n5 ON e4.txId2 = n5.txId WHERE n1.class = ''1'' AND e4.txId2 != n1.txId AND e4.txId2 != n2.txId AND e4.txId2 != n3.txId GROUP BY e4.txId2 ORDER BY hop_distance, node_id');

-- Session query 2
.print 'Query 2:'
call gpu_processing('SELECT e1.txId2 AS node_id, MAX(n2.class) AS node_class, 1 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId WHERE n1.class = ''1'' GROUP BY e1.txId2 UNION ALL SELECT e2.txId2 AS node_id, MAX(n3.class) AS node_class, 2 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId WHERE n1.class = ''1'' AND e2.txId2 != n1.txId GROUP BY e2.txId2 UNION ALL SELECT e3.txId2 AS node_id, MAX(n4.class) AS node_class, 3 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId JOIN edges e3 ON n3.txId = e3.txId1 JOIN nodes n4 ON e3.txId2 = n4.txId WHERE n1.class = ''1'' AND e3.txId2 != n1.txId AND e3.txId2 != n2.txId GROUP BY e3.txId2 UNION ALL SELECT e4.txId2 AS node_id, MAX(n5.class) AS node_class, 4 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId JOIN edges e3 ON n3.txId = e3.txId1 JOIN nodes n4 ON e3.txId2 = n4.txId JOIN edges e4 ON n4.txId = e4.txId1 JOIN nodes n5 ON e4.txId2 = n5.txId WHERE n1.class = ''1'' AND e4.txId2 != n1.txId AND e4.txId2 != n2.txId AND e4.txId2 != n3.txId GROUP BY e4.txId2 ORDER BY hop_distance, node_id');

-- Session query 3
.print 'Query 3:'
call gpu_processing('SELECT e1.txId2 AS node_id, MAX(n2.class) AS node_class, 1 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId WHERE n1.class = ''1'' GROUP BY e1.txId2 UNION ALL SELECT e2.txId2 AS node_id, MAX(n3.class) AS node_class, 2 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId WHERE n1.class = ''1'' AND e2.txId2 != n1.txId GROUP BY e2.txId2 UNION ALL SELECT e3.txId2 AS node_id, MAX(n4.class) AS node_class, 3 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId JOIN edges e3 ON n3.txId = e3.txId1 JOIN nodes n4 ON e3.txId2 = n4.txId WHERE n1.class = ''1'' AND e3.txId2 != n1.txId AND e3.txId2 != n2.txId GROUP BY e3.txId2 UNION ALL SELECT e4.txId2 AS node_id, MAX(n5.class) AS node_class, 4 AS hop_distance FROM nodes n1 JOIN edges e1 ON n1.txId = e1.txId1 JOIN nodes n2 ON e1.txId2 = n2.txId JOIN edges e2 ON n2.txId = e2.txId1 JOIN nodes n3 ON e2.txId2 = n3.txId JOIN edges e3 ON n3.txId = e3.txId1 JOIN nodes n4 ON e3.txId2 = n4.txId JOIN edges e4 ON n4.txId = e4.txId1 JOIN nodes n5 ON e4.txId2 = n5.txId WHERE n1.class = ''1'' AND e4.txId2 != n1.txId AND e4.txId2 != n2.txId AND e4.txId2 != n3.txId GROUP BY e4.txId2 ORDER BY hop_distance, node_id');
